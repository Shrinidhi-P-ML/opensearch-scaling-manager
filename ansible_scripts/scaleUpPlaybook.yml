---
- hosts: current_nodes

  tasks:

  - name: Add new host | Add new node into hosts file
    become_user: root
    become: yes
    lineinfile:
      path: /etc/hosts
      line: "{{ hostvars[item]['ansible_private_host'] }} {{ item }}.{{ domain_name }} {{ item }}"
      state: present
      create: yes
    with_items: "{{ groups['new_node'] }}"

# Needs a restart of opensearch after this is included. Otherwise, needs to be added as a pre-requisite
#  - name: Certificate inclusion | Certificates to match regex
#    replace:
#      path: "{{os_conf_dir}}/opensearch.yml"
#      regexp: 'CN={{ item }}'
#      replace: "CN=*"
#    become: yes
#    with_items: "{{ groups['current_nodes'] }}"

- hosts: new_node
  gather_facts: no
  name: Scale-up role-based playbook
  become: yes

  roles:
    - scale_up

- hosts: all

  tasks:

  - name: Update Hosts | Add the new node into all unicast files
    lineinfile:
      path: "{{os_conf_dir}}/unicast_hosts.txt"
      line: "{{ hostvars[item]['ansible_private_host'] }}"
      state: present
      backup: yes
    with_items: "{{ groups['new_node'] }}"
    become: yes

- hosts: new_node
  gather_facts: no
  name: Custom role-based tasks
  become: yes

  roles:
    - custom_role
